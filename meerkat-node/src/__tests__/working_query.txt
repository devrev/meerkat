SELECT
  * exclude (__row_id)
FROM
  (
    SELECT
      MAX(__resolved_query."Ticket Id") AS "Ticket Id",
      ARRAY_AGG(DISTINCT __resolved_query."Tags - Tag name") AS "Tags - Tag name",
      "__row_id"
    FROM
      (
        SELECT
          __resolved_query."__row_id" AS "__row_id",
          *
        FROM
          (
            SELECT
              "Tags - Tag name",
              "Ticket Id",
              "__row_id"
            FROM
              (
                SELECT
                  __unnested_base_query."Ticket Id" AS "Ticket Id",
                  __unnested_base_query."__row_id" AS "__row_id",
                  *
                FROM
                  (
                    SELECT
                      "Ticket Id",
                      "Tags",
                      "__row_id"
                    FROM
                      (
                        SELECT
                          __base_query."Ticket Id" AS "Ticket Id",
                          unnest(__base_query."Tags") AS "Tags",
                          row_number() OVER () AS "__row_id",
                          *
                        FROM
                          (
                            SELECT
                              count("ID") AS "Ticket Id",
                              "Tags"
                            FROM
                              (
                                SELECT
                                  dim_ticket.created_date AS "Created date",
                                  'ticket' AS "Work Type",
                                  json_extract_string(dim_ticket.stage_json, '$.stage_id') AS "Stage",
                                  CAST(
                                    json_extract_string(dim_ticket.tags_json, '$[*].tag_id') AS VARCHAR[]
                                  ) AS "Tags",
                                  dim_ticket.id AS "ID",
                                  *
                                FROM
                                  (
                                    SELECT
                                      *
                                    FROM
                                      devrev.dim_ticket
                                  ) AS dim_ticket
                              ) AS dim_ticket
                            WHERE
                              (
                                (
                                  (
                                    ("Created date" >= '2025-08-02T09:30:00.000Z')
                                    AND ("Created date" <= '2025-10-31T10:29:59.999Z')
                                  )
                                  AND ("Work Type" IN ('ticket'))
                                  AND (
                                    Stage IN (
                                      'don:core:dvrv-us-1:devo/787:custom_stage/514',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/512',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/501',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/485',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/440',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/25',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/24',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/22',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/21',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/19',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/13',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/10',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/8',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/7',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/6',
                                      'don:core:dvrv-us-1:devo/787:custom_stage/4'
                                    )
                                  )
                                )
                              )
                            GROUP BY
                              Tags
                            LIMIT
                              50000
                          ) AS __base_query
                      ) AS __base_query
                  ) AS __unnested_base_query
                  LEFT JOIN (
                    SELECT
                      __unnested_base_query__dim_ticket__tags_json.name AS "Tags - Tag name",
                      *
                    FROM
                      (
                        SELECT
                          *
                        FROM
                          devrev.dim_tag
                      ) AS __unnested_base_query__dim_ticket__tags_json
                  ) AS __unnested_base_query__dim_ticket__tags_json ON __unnested_base_query."Tags" = __unnested_base_query__dim_ticket__tags_json.id
              ) AS MEERKAT_GENERATED_TABLE
          ) AS __resolved_query
      ) AS __resolved_query
    GROUP BY
      __row_id
  )